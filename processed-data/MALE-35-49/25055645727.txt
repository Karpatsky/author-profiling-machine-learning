Well, that's some butt-ugly code I've just written.  Need to sleep on it then tidy it up in the morning.  It does work, though :)