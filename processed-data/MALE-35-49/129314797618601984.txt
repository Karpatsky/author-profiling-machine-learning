Big new function added, big refactor done to support it, and all the tests are passing again. I'll take today :)